---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: healthchecks.aiops.prophet.io
spec:
  group: aiops.prophet.io
  names:
    kind: HealthCheck
    listKind: HealthCheckList
    plural: healthchecks
    singular: healthcheck
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.healthy
      name: Healthy
      type: boolean
    - jsonPath: .spec.targetRef.kind + '/' + .spec.targetRef.name
      name: Target
      type: string
    - jsonPath: .status.failureCount
      name: Failure Count
      type: integer
    - jsonPath: .status.lastCheckTime
      name: Last Check
      type: date
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: HealthCheck is the Schema for the healthchecks API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: HealthCheckSpec defines the desired state of HealthCheck
            properties:
              failureThreshold:
                default: 3
                description: |-
                  FailureThreshold is the number of consecutive failures before marking unhealthy
                  Default: 3
                format: int32
                type: integer
              initialDelaySeconds:
                default: 0
                description: |-
                  InitialDelaySeconds is the delay before starting health checks
                  Default: 0
                format: int32
                type: integer
              periodSeconds:
                default: 10
                description: |-
                  PeriodSeconds is the interval between health checks in seconds
                  Default: 10
                format: int32
                type: integer
              probes:
                description: Probes defines the health check probes to execute
                items:
                  description: ProbeSpec defines a single health check probe
                  properties:
                    custom:
                      description: |-
                        Custom defines a custom health check (e.g., database connectivity)
                        Used when type is "custom"
                      properties:
                        description:
                          description: Description of what this custom probe checks
                          type: string
                        env:
                          description: Env defines environment variables for the custom
                            probe
                          items:
                            description: EnvVar represents an environment variable
                              present in a Container.
                            properties:
                              name:
                                description: Name of the environment variable. Must
                                  be a C_IDENTIFIER.
                                type: string
                              value:
                                description: |-
                                  Variable references $(VAR_NAME) are expanded
                                  using the previously defined environment variables in the container and
                                  any service environment variables. If a variable cannot be resolved,
                                  the reference in the input string will be unchanged. Double $$ are reduced
                                  to a single $, which allows for escaping the $(VAR_NAME) syntax: i.e.
                                  "$$(VAR_NAME)" will produce the string literal "$(VAR_NAME)".
                                  Escaped references will never be expanded, regardless of whether the variable
                                  exists or not.
                                  Defaults to "".
                                type: string
                              valueFrom:
                                description: Source for the environment variable's
                                  value. Cannot be used if value is not empty.
                                properties:
                                  configMapKeyRef:
                                    description: Selects a key of a ConfigMap.
                                    properties:
                                      key:
                                        description: The key to select.
                                        type: string
                                      name:
                                        description: |-
                                          Name of the referent.
                                          More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                                        type: string
                                      optional:
                                        description: Specify whether the ConfigMap
                                          or its key must be defined
                                        type: boolean
                                    required:
                                    - key
                                    type: object
                                    x-kubernetes-map-type: atomic
                                  fieldRef:
                                    description: |-
                                      Selects a field of the pod: supports metadata.name, metadata.namespace, `metadata.labels['<KEY>']`, `metadata.annotations['<KEY>']`,
                                      spec.nodeName, spec.serviceAccountName, status.hostIP, status.podIP, status.podIPs.
                                    properties:
                                      apiVersion:
                                        description: Version of the schema the FieldPath
                                          is written in terms of, defaults to "v1".
                                        type: string
                                      fieldPath:
                                        description: Path of the field to select in
                                          the specified API version.
                                        type: string
                                    required:
                                    - fieldPath
                                    type: object
                                    x-kubernetes-map-type: atomic
                                  resourceFieldRef:
                                    description: |-
                                      Selects a resource of the container: only resources limits and requests
                                      (limits.cpu, limits.memory, limits.ephemeral-storage, requests.cpu, requests.memory and requests.ephemeral-storage) are currently supported.
                                    properties:
                                      containerName:
                                        description: 'Container name: required for
                                          volumes, optional for env vars'
                                        type: string
                                      divisor:
                                        anyOf:
                                        - type: integer
                                        - type: string
                                        description: Specifies the output format of
                                          the exposed resources, defaults to "1"
                                        pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                        x-kubernetes-int-or-string: true
                                      resource:
                                        description: 'Required: resource to select'
                                        type: string
                                    required:
                                    - resource
                                    type: object
                                    x-kubernetes-map-type: atomic
                                  secretKeyRef:
                                    description: Selects a key of a secret in the
                                      pod's namespace
                                    properties:
                                      key:
                                        description: The key of the secret to select
                                          from.  Must be a valid secret key.
                                        type: string
                                      name:
                                        description: |-
                                          Name of the referent.
                                          More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                                        type: string
                                      optional:
                                        description: Specify whether the Secret or
                                          its key must be defined
                                        type: boolean
                                    required:
                                    - key
                                    type: object
                                    x-kubernetes-map-type: atomic
                                type: object
                            required:
                            - name
                            type: object
                          type: array
                        image:
                          description: |-
                            Image is the container image to use for executing the custom probe
                            If not specified, uses the target workload's container image
                          type: string
                        script:
                          description: Script is a shell script or command to execute
                            for the custom check
                          type: string
                      type: object
                    exec:
                      description: Exec defines a command-based health check (used
                        when type is "command")
                      properties:
                        command:
                          description: |-
                            Command is the command line to execute inside the container, the working directory for the
                            command  is root ('/') in the container's filesystem. The command is simply exec'd, it is
                            not run inside a shell, so traditional shell instructions ('|', etc) won't work. To use
                            a shell, you need to explicitly call out to that shell.
                            Exit status of 0 is treated as live/healthy and non-zero is unhealthy.
                          items:
                            type: string
                          type: array
                      type: object
                    httpGet:
                      description: HTTPGet defines an HTTP health check (used when
                        type is "http")
                      properties:
                        host:
                          description: |-
                            Host name to connect to, defaults to the pod IP. You probably want to set
                            "Host" in httpHeaders instead.
                          type: string
                        httpHeaders:
                          description: Custom headers to set in the request. HTTP
                            allows repeated headers.
                          items:
                            description: HTTPHeader describes a custom header to be
                              used in HTTP probes
                            properties:
                              name:
                                description: |-
                                  The header field name.
                                  This will be canonicalized upon output, so case-variant names will be understood as the same header.
                                type: string
                              value:
                                description: The header field value
                                type: string
                            required:
                            - name
                            - value
                            type: object
                          type: array
                        path:
                          description: Path to access on the HTTP server.
                          type: string
                        port:
                          anyOf:
                          - type: integer
                          - type: string
                          description: |-
                            Name or number of the port to access on the container.
                            Number must be in the range 1 to 65535.
                            Name must be an IANA_SVC_NAME.
                          x-kubernetes-int-or-string: true
                        scheme:
                          description: |-
                            Scheme to use for connecting to the host.
                            Defaults to HTTP.
                          type: string
                      required:
                      - port
                      type: object
                    name:
                      description: Name is a unique identifier for this probe
                      type: string
                    tcpSocket:
                      description: TCPSocket defines a TCP health check (used when
                        type is "tcp")
                      properties:
                        host:
                          description: 'Optional: Host name to connect to, defaults
                            to the pod IP.'
                          type: string
                        port:
                          anyOf:
                          - type: integer
                          - type: string
                          description: |-
                            Number or name of the port to access on the container.
                            Number must be in the range 1 to 65535.
                            Name must be an IANA_SVC_NAME.
                          x-kubernetes-int-or-string: true
                      required:
                      - port
                      type: object
                    type:
                      description: 'Type of probe: "http", "tcp", "command", or "custom"'
                      enum:
                      - http
                      - tcp
                      - command
                      - custom
                      type: string
                  required:
                  - name
                  - type
                  type: object
                type: array
              remediation:
                description: Remediation defines what action to take when health check
                  fails
                properties:
                  action:
                    description: 'Action to take: "restart", "trigger-recovery-plan",
                      "alert", or "none"'
                    enum:
                    - restart
                    - trigger-recovery-plan
                    - alert
                    - none
                    type: string
                  cooldownSeconds:
                    default: 300
                    description: |-
                      CooldownSeconds is the minimum time between remediation actions
                      Default: 300 (5 minutes)
                    format: int32
                    type: integer
                  recoveryPlanRef:
                    description: |-
                      RecoveryPlanRef references an AnomalyAction to trigger for recovery
                      Used when action is "trigger-recovery-plan"
                    properties:
                      name:
                        description: Name of the AnomalyAction resource
                        type: string
                      namespace:
                        description: Namespace of the AnomalyAction (optional, defaults
                          to HealthCheck namespace)
                        type: string
                    required:
                    - name
                    type: object
                  requireApproval:
                    description: |-
                      RequireApproval requires manual approval before executing remediation
                      Default: false
                    type: boolean
                required:
                - action
                type: object
              targetRef:
                description: TargetRef references the workload to check (Deployment,
                  StatefulSet, Pod, etc.)
                properties:
                  apiVersion:
                    description: APIVersion of the target resource (e.g., "apps/v1")
                    type: string
                  kind:
                    description: Kind of the target resource (e.g., "Deployment",
                      "StatefulSet", "Pod")
                    type: string
                  name:
                    description: Name of the target resource
                    type: string
                  namespace:
                    description: Namespace of the target resource (optional, defaults
                      to HealthCheck namespace)
                    type: string
                required:
                - apiVersion
                - kind
                - name
                type: object
              timeoutSeconds:
                default: 5
                description: |-
                  TimeoutSeconds is the timeout for each probe execution
                  Default: 5
                format: int32
                type: integer
            required:
            - probes
            - targetRef
            type: object
          status:
            description: HealthCheckStatus defines the observed state of HealthCheck
            properties:
              conditions:
                description: Conditions represent the latest available observations
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              errorMessage:
                description: ErrorMessage contains any error message from the last
                  check
                type: string
              failureCount:
                description: FailureCount is the number of consecutive failures
                format: int32
                type: integer
              healthy:
                description: Healthy indicates whether the target workload is currently
                  healthy
                type: boolean
              lastCheckTime:
                description: LastCheckTime is the timestamp of the last health check
                format: date-time
                type: string
              lastFailureTime:
                description: LastFailureTime is the timestamp of the last failure
                format: date-time
                type: string
              lastRemediationTime:
                description: LastRemediationTime is the timestamp of the last remediation
                  action
                format: date-time
                type: string
              probeResults:
                description: ProbeResults contains the results of each probe
                items:
                  description: ProbeResult contains the result of a single probe execution
                  properties:
                    lastCheckTime:
                      description: LastCheckTime is when this probe was last executed
                      format: date-time
                      type: string
                    message:
                      description: Message contains additional information about the
                        probe result
                      type: string
                    name:
                      description: Name of the probe
                      type: string
                    success:
                      description: Success indicates whether the probe succeeded
                      type: boolean
                  required:
                  - name
                  - success
                  type: object
                type: array
              remediationCount:
                description: RemediationCount is the number of remediation actions
                  performed
                format: int32
                type: integer
            required:
            - failureCount
            - healthy
            - remediationCount
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: health-check-controller-manager
  namespace: prophet-operators

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: health-check-manager-role
rules:
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - delete
  - get
  - list
  - watch
- apiGroups:
  - aiops.prophet.io
  resources:
  - anomalyactions
  verbs:
  - create
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - aiops.prophet.io
  resources:
  - healthchecks
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - aiops.prophet.io
  resources:
  - healthchecks/finalizers
  verbs:
  - update
- apiGroups:
  - aiops.prophet.io
  resources:
  - healthchecks/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - apps
  resources:
  - deployments
  - statefulsets
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: health-check-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: health-check-manager-role
subjects:
- kind: ServiceAccount
  name: health-check-controller-manager
  namespace: prophet-operators
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: health-check-controller-manager
  namespace: prophet-operators
  labels:
    app: health-check
spec:
  replicas: 1
  selector:
    matchLabels:
      app: health-check
  template:
    metadata:
      labels:
        app: health-check
    spec:
      serviceAccountName: health-check-controller-manager
      containers:
      - command:
        - /manager
        args:
        - --leader-elect
        image: ghcr.io/prophet-aiops/prophet-health-check:latest
        name: manager
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 128Mi
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10

