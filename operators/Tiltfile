# Tiltfile for All Prophet Operators
# Run with: tilt up
# Access UI at: http://localhost:10350
# 
# Tilt is the SINGLE SOURCE OF TRUTH for operator builds and deployments.
# - Watches Go source files
# - Builds Docker images automatically (via Dockerfile)
# - Loads images into kind cluster
# - Deploys operators via manifests from clusters/
# 
# DO NOT run `go build` or `docker build` manually for operators.
# Tilt handles the entire build â†’ load â†’ deploy cycle.

# List of all operators to build
OPERATORS = [
    'health-check',
    'budget-guard',
    'cost-alert',
    'diagnostic-remediator',
    'label-enforcer',
]

# Allow filtering via args: tilt up -- --operators=anomaly-remediator,diagnostic-remediator
selected_operators = ARGV.get('operators', '').split(',')
if selected_operators and selected_operators != ['']:
    OPERATORS = [op.strip() for op in selected_operators if op.strip()]

# Base image registry
IMAGE_REGISTRY = 'ghcr.io/prophet-aiops'
# Use 'latest' tag to match deployment manifests, or 'dev' for development
IMAGE_TAG = 'latest'

# Helper function to setup each operator
def setup_operator(operator_name):
    """Setup a single operator: build image, deploy CRDs, deploy operator"""
    # Paths are relative to operators/ directory where Tiltfile runs
    operator_dir = operator_name
    
    # Check if operator exists
    if not os.path.exists(operator_dir):
        print('âš ï¸  Operator not found: ' + operator_name)
        return
    
    # Check if Dockerfile exists
    dockerfile_path = operator_dir + '/Dockerfile'
    if not os.path.exists(dockerfile_path):
        print('âš ï¸  Dockerfile not found for: ' + operator_name)
        return
    
    image_name = IMAGE_REGISTRY + '/prophet-' + operator_name
    
    # Build Docker image
    docker_build(
        image_name + ':' + IMAGE_TAG,
        operator_dir,
        dockerfile=dockerfile_path,
        live_update=[
            # Hot reload: sync compiled binary directly
            sync(operator_dir + '/bin/manager', '/manager'),
            # Fallback: rebuild on source changes
            fall_back_on([
                operator_dir + '/go.mod',
                operator_dir + '/go.sum',
                operator_dir + '/api/',
                operator_dir + '/controllers/',
                operator_dir + '/cmd/',
            ]),
        ],
        ignore=[
            operator_dir + '/bin/',
            operator_dir + '/.git/',
            operator_dir + '/cover.out',
        ],
    )
    
    # Deploy CRDs (if config/crd exists)
    crd_path = operator_dir + '/config/crd'
    if os.path.exists(crd_path):
        k8s_yaml(kustomize(crd_path))
    
    # Deploy operator from clusters/ manifest (single source of truth)
    # This ensures Tilt uses the same manifests as production
    cluster_manifest = '../clusters/common/aiops/operators/' + operator_name + '.yaml'
    if os.path.exists(cluster_manifest):
        k8s_yaml(local(cluster_manifest))
    else:
        # Fallback: try kustomize config/default
        default_path = operator_dir + '/config/default'
        if os.path.exists(default_path):
            k8s_yaml(kustomize(default_path))
        else:
            # Fallback: try config/manager
            manager_path = operator_dir + '/config/manager'
            if os.path.exists(manager_path):
                k8s_yaml(kustomize(manager_path))
    
    # Update image in deployment
    resource_name = operator_name + '-controller-manager'
    k8s_resource(
        resource_name,
        image=image_name + ':' + IMAGE_TAG,
        port_forwards=['8080:8080', '8081:8081'],
        resource_deps=[image_name + ':' + IMAGE_TAG],
    )
    
    # Apply test CRs if available
    samples_path = operator_dir + '/config/samples'
    if os.path.exists(samples_path):
        local_resource(
            'apply-test-cr-' + operator_name,
            cmd='kubectl apply -f ' + samples_path + ' 2>/dev/null || echo "No test CRs for ' + operator_name + '"',
            deps=[samples_path],
            allow_parallel=True,
        )
    
    print('âœ… Setup complete for: ' + operator_name)

# Setup all operators
for op in OPERATORS:
    setup_operator(op)

print('ðŸš€ Tilt is running for ' + str(len(OPERATORS)) + ' operator(s)')
print('ðŸ“Š UI: http://localhost:10350')
print('ðŸ”§ Filter operators: tilt args --operators=health-check,diagnostic-remediator')
