name: CI - Manifest Validation

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: YAML Linting
        run: |
          echo "Running yamllint on all YAML files..."
          find . -type f \( -name "*.yaml" -o -name "*.yml" \) \
            ! -path "./.git/*" \
            ! -path "./operators/*/bin/*" \
            ! -path "./operators/*/vendor/*" \
            ! -path "./node_modules/*" \
            -exec yamllint -d relaxed {} \; || true

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.3.0"

      - name: Kustomize Build & Validate
        run: |
          echo "Validating kustomize builds..."
          for dir in clusters/*/base clusters/*/overlays/*; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Building $dir..."
              kustomize build "$dir" > /dev/null || {
                echo "❌ Kustomize build failed for $dir"
                exit 1
              }
            fi
          done
          echo "✅ All kustomize builds successful"

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install kubeconform
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/v0.6.3/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -version

      - name: Schema Validation with kubeconform
        run: |
          echo "Validating Kubernetes schemas..."
          for dir in clusters/*/base clusters/*/overlays/*; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Validating $dir..."
              kustomize build "$dir" | kubeconform -strict -summary || {
                echo "❌ Schema validation failed for $dir"
                exit 1
              }
            fi
          done
          # Validate operator manifests
          if [ -d "operators" ]; then
            find operators -name "*.yaml" -type f | while read -r file; do
              if grep -q "kind:" "$file"; then
                echo "Validating $file..."
                kubeconform -strict "$file" || {
                  echo "❌ Schema validation failed for $file"
                  exit 1
                }
              fi
            done
          fi
          echo "✅ All schema validations passed"

      - name: Install Trivy
        uses: aquasecurity/trivy-action@master
        with:
          trivy_version: 'latest'

      - name: Scan Container Images
        run: |
          echo "Scanning container images referenced in manifests..."
          # Extract images from manifests
          find . -type f \( -name "*.yaml" -o -name "*.yml" \) \
            ! -path "./.git/*" \
            ! -path "./operators/*/bin/*" \
            ! -path "./operators/*/vendor/*" \
            -exec grep -h "image:" {} \; | \
            sed 's/.*image: *//' | \
            sed 's/{{.*}}//' | \
            grep -v "^$" | \
            sort -u | \
            while read -r image; do
              if [[ "$image" =~ ^[a-zA-Z0-9._/-]+:[a-zA-Z0-9._-]+$ ]] || [[ "$image" =~ ^[a-zA-Z0-9._/-]+$ ]]; then
                echo "Scanning $image..."
                trivy image --exit-code 0 --severity HIGH,CRITICAL --format table "$image" || true
              fi
            done

      - name: Install Checkov
        run: |
          pip install checkov

      - name: Security Scanning with Checkov
        run: |
          echo "Running Checkov security scan..."
          checkov -d . \
            --framework kubernetes \
            --skip-check CKV_K8S_* \
            --quiet \
            --compact \
            --output cli || {
            echo "⚠️ Checkov found security issues (non-blocking)"
          }

      - name: Install kube-linter
        run: |
          wget -q https://github.com/stackrox/kube-linter/releases/download/v0.6.0/kube-linter-linux.tar.gz
          tar -xzf kube-linter-linux.tar.gz
          sudo mv kube-linter /usr/local/bin/
          kube-linter version

      - name: Best Practices Check with kube-linter
        run: |
          echo "Running kube-linter best practices check..."
          for dir in clusters/*/base clusters/*/overlays/*; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Linting $dir..."
              kustomize build "$dir" | kube-linter lint - || {
                echo "⚠️ kube-linter found issues in $dir (non-blocking)"
              }
            fi
          done

      - name: Validate Helm Charts
        run: |
          if command -v helm &> /dev/null; then
            echo "Validating Helm charts..."
            for chart in apps/helm-charts/*/; do
              if [ -f "$chart/Chart.yaml" ]; then
                echo "Validating $chart..."
                helm lint "$chart" || {
                  echo "❌ Helm lint failed for $chart"
                  exit 1
                }
                helm template test "$chart" > /dev/null || {
                  echo "❌ Helm template failed for $chart"
                  exit 1
                }
              fi
            done
            echo "✅ All Helm charts validated"
          else
            echo "⚠️ Helm not installed, skipping chart validation"
          fi

      - name: Summary
        run: |
          echo "✅ Manifest validation complete!"
          echo "All YAML files linted, kustomize builds validated, schemas checked, and security scanned."

